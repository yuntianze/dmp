cmake_minimum_required(VERSION 3.20)

# å¼ºåˆ¶è®¾ç½® Apple Silicon (arm64) æ¶æ„
if(APPLE)
    set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "Target architecture" FORCE)
    set(CMAKE_SYSTEM_PROCESSOR "arm64" CACHE STRING "Target architecture" FORCE)
    set(CMAKE_HOST_SYSTEM_PROCESSOR "arm64" CACHE STRING "Host architecture" FORCE)
    message(STATUS "ğŸ å¼ºåˆ¶è®¾ç½® Apple Silicon (arm64) æ¶æ„")
endif()

project(dmp_prototype VERSION 1.0.0 LANGUAGES CXX)

# é‡æ–°ç¡®è®¤æ¶æ„è®¾ç½®
if(APPLE)
    set(CMAKE_SYSTEM_PROCESSOR "arm64" CACHE STRING "Target architecture" FORCE)
endif()

# C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)



# ç¼–è¯‘é€‰é¡¹ - Apple Silicon ä¼˜åŒ–
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -flto -fomit-frame-pointer")
set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g3 -fno-omit-frame-pointer -fsanitize=address,undefined")

# LTO ä¼˜åŒ–
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE ON)

# ============================================================================
# Third Party ä¾èµ–è·¯å¾„é…ç½® - ä¿®å¤ç‰ˆæœ¬
# ============================================================================

# è®¾ç½®ç¬¬ä¸‰æ–¹åº“æ ¹ç›®å½•
set(THIRD_PARTY_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/third_party/install")
set(THIRD_PARTY_SRC "${CMAKE_CURRENT_SOURCE_DIR}/third_party/src")

# å¿½ç•¥ç³»ç»Ÿåº“è·¯å¾„ä»¥é¿å…ç‰ˆæœ¬å†²çª
set(CMAKE_IGNORE_PATH "/usr/local/include;/usr/local/lib;/opt/homebrew/include;/opt/homebrew/lib")

# å°†ç¬¬ä¸‰æ–¹åº“è·¯å¾„æ·»åŠ åˆ° CMAKE_PREFIX_PATH
list(PREPEND CMAKE_PREFIX_PATH "${THIRD_PARTY_ROOT}")

# åŒ…å«ç›®å½•
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${THIRD_PARTY_ROOT}/include)
include_directories(${THIRD_PARTY_SRC}/include)  # åŒ…å«header-only fmt

# åº“ç›®å½•
link_directories(${THIRD_PARTY_ROOT}/lib)

# ============================================================================
# åŸºç¡€ä¾èµ–
# ============================================================================

find_package(Threads REQUIRED)

# ============================================================================
# Third Party åº“é…ç½® - ä¿®å¤ç‰ˆæœ¬
# ============================================================================

# fmt åº“ - Header-only æ¨¡å¼ï¼Œé¿å…é“¾æ¥å†²çª
add_library(fmt INTERFACE)
target_include_directories(fmt INTERFACE "${THIRD_PARTY_SRC}/include")
target_compile_definitions(fmt INTERFACE FMT_HEADER_ONLY=1)

# spdlog åº“ - é™æ€é“¾æ¥
find_library(SPDLOG_LIBRARY 
    NAMES spdlog
    PATHS ${THIRD_PARTY_ROOT}/lib
    NO_DEFAULT_PATH
    REQUIRED
)

add_library(spdlog::spdlog UNKNOWN IMPORTED)
set_target_properties(spdlog::spdlog PROPERTIES
    IMPORTED_LOCATION "${SPDLOG_LIBRARY}"
    INTERFACE_INCLUDE_DIRECTORIES "${THIRD_PARTY_ROOT}/include"
    INTERFACE_COMPILE_DEFINITIONS "SPDLOG_COMPILED_LIB"
)

# simdjson åº“
find_library(SIMDJSON_LIBRARY 
    NAMES simdjson
    PATHS ${THIRD_PARTY_ROOT}/lib
    NO_DEFAULT_PATH
    REQUIRED
)

add_library(simdjson::simdjson UNKNOWN IMPORTED)
set_target_properties(simdjson::simdjson PROPERTIES
    IMPORTED_LOCATION "${SIMDJSON_LIBRARY}"
    INTERFACE_INCLUDE_DIRECTORIES "${THIRD_PARTY_ROOT}/include"
)

# parallel-hashmap åº“ - Header-only
add_library(phmap INTERFACE)
target_include_directories(phmap INTERFACE "${THIRD_PARTY_ROOT}/include")

# toml++ åº“ - Header-only
add_library(tomlplusplus INTERFACE)
target_include_directories(tomlplusplus INTERFACE "${THIRD_PARTY_ROOT}/include")

# ============================================================================
# å¯é€‰ä¾èµ– - ONNX Runtime
# ============================================================================

find_library(ONNXRUNTIME_LIBRARY 
    NAMES onnxruntime
    PATHS ${THIRD_PARTY_ROOT}/lib
    NO_DEFAULT_PATH
)

if(ONNXRUNTIME_LIBRARY AND EXISTS "${THIRD_PARTY_ROOT}/include/onnxruntime_cxx_api.h")
    add_library(ONNXRuntime::onnxruntime UNKNOWN IMPORTED)
    set_target_properties(ONNXRuntime::onnxruntime PROPERTIES
        IMPORTED_LOCATION "${ONNXRUNTIME_LIBRARY}"
        INTERFACE_INCLUDE_DIRECTORIES "${THIRD_PARTY_ROOT}/include"
    )
    set(ENABLE_ML_INFERENCE ON)
    set(ONNXRUNTIME_LIBRARIES ONNXRuntime::onnxruntime)
    message(STATUS "âœ… æ‰¾åˆ° ONNX Runtimeï¼Œå¯ç”¨ ML æ¨ç†åŠŸèƒ½: ${ONNXRUNTIME_LIBRARY}")
else()
    set(ENABLE_ML_INFERENCE OFF)
    set(ONNXRUNTIME_LIBRARIES "")
    message(WARNING "âš ï¸ æœªæ‰¾åˆ° ONNX Runtimeï¼Œç¦ç”¨ ML æ¨ç†åŠŸèƒ½")
endif()

# ============================================================================
# Hyperscan/Vectorscan é…ç½®
# ============================================================================

find_library(HYPERSCAN_LIBRARY 
    NAMES hs hyperscan
    PATHS ${THIRD_PARTY_ROOT}/lib /opt/homebrew/lib
)

find_path(HYPERSCAN_INCLUDE_DIR
    NAMES hs/hs.h
    PATHS ${THIRD_PARTY_ROOT}/include /opt/homebrew/include
)

if(HYPERSCAN_LIBRARY AND HYPERSCAN_INCLUDE_DIR)
    add_library(Hyperscan::hyperscan UNKNOWN IMPORTED)
    set_target_properties(Hyperscan::hyperscan PROPERTIES
        IMPORTED_LOCATION "${HYPERSCAN_LIBRARY}"
        INTERFACE_INCLUDE_DIRECTORIES "${HYPERSCAN_INCLUDE_DIR}"
    )
    set(HYPERSCAN_LIBRARIES Hyperscan::hyperscan)
    message(STATUS "âœ… æ‰¾åˆ° Hyperscan/Vectorscan: ${HYPERSCAN_LIBRARY}")
else()
    message(WARNING "âš ï¸ Hyperscan/Vectorscan åº“æœªæ‰¾åˆ°ï¼Œå°†ç¦ç”¨æ¨¡å¼åŒ¹é…åŠŸèƒ½")
    set(HYPERSCAN_LIBRARIES "")
endif()

# ============================================================================
# åˆ›å»ºç®€åŒ–çš„prometheus-cppæ›¿ä»£
# ============================================================================

# åˆ›å»ºç®€åŒ–çš„metricsåº“
add_library(simple_metrics INTERFACE)
target_include_directories(simple_metrics INTERFACE "${CMAKE_CURRENT_SOURCE_DIR}/include")

# ============================================================================
# æ ¸å¿ƒåº“
# ============================================================================

add_subdirectory(src)

# ============================================================================
# GoogleTest é…ç½®
# ============================================================================

find_library(GTEST_LIBRARY 
    NAMES gtest
    PATHS ${THIRD_PARTY_ROOT}/lib
    NO_DEFAULT_PATH
)

find_library(GTEST_MAIN_LIBRARY 
    NAMES gtest_main
    PATHS ${THIRD_PARTY_ROOT}/lib
    NO_DEFAULT_PATH
)

if(GTEST_LIBRARY AND GTEST_MAIN_LIBRARY AND EXISTS "${THIRD_PARTY_ROOT}/include/gtest/gtest.h")
    add_library(GTest::gtest UNKNOWN IMPORTED)
    set_target_properties(GTest::gtest PROPERTIES
        IMPORTED_LOCATION "${GTEST_LIBRARY}"
        INTERFACE_INCLUDE_DIRECTORIES "${THIRD_PARTY_ROOT}/include"
    )
    
    add_library(GTest::gtest_main UNKNOWN IMPORTED)
    set_target_properties(GTest::gtest_main PROPERTIES
        IMPORTED_LOCATION "${GTEST_MAIN_LIBRARY}"
        INTERFACE_INCLUDE_DIRECTORIES "${THIRD_PARTY_ROOT}/include"
    )
    
    set(GTEST_FOUND ON)
    message(STATUS "âœ… æ‰¾åˆ° GoogleTest: ${GTEST_LIBRARY}")
else()
    set(GTEST_FOUND OFF)
    message(WARNING "âš ï¸ GoogleTest æœªæ‰¾åˆ°ï¼Œå°†ç¦ç”¨æµ‹è¯•")
endif()

# ============================================================================
# æµ‹è¯•é…ç½®
# ============================================================================

option(BUILD_TESTING "Build tests" ON)
if(BUILD_TESTING AND GTEST_FOUND)
    enable_testing()
    add_subdirectory(tests)
endif()

# ============================================================================
# ä¸»å¯æ‰§è¡Œæ–‡ä»¶
# ============================================================================

add_executable(dmp_server src/main.cpp)

# é“¾æ¥æ‰€æœ‰ä¾èµ– - ä¿®å¤ç‰ˆæœ¬
target_link_libraries(dmp_server PRIVATE
    dmp_core
    fmt                     # Header-only fmt
    spdlog::spdlog         # spdlog æ—¥å¿—åº“
    simdjson::simdjson
    phmap
    tomlplusplus
    simple_metrics         # ç®€åŒ–metricsåº“
    ${HYPERSCAN_LIBRARIES}
    ${ONNXRUNTIME_LIBRARIES}
    Threads::Threads
)

# åº”ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–é€‰é¡¹
include(${CMAKE_CURRENT_SOURCE_DIR}/cmake/CompilerOptions.cmake)
set_optimization_flags(dmp_server)

# ============================================================================
# å®‰è£…é…ç½®
# ============================================================================

install(TARGETS dmp_server DESTINATION bin)
install(DIRECTORY config/ DESTINATION etc/dmp)

# ============================================================================
# æ„å»ºä¿¡æ¯æ˜¾ç¤º
# ============================================================================

message(STATUS "")
message(STATUS "ğŸš€ DMP é£æ§ç³»ç»Ÿæ„å»ºé…ç½® - ä¿®å¤ç‰ˆæœ¬")
message(STATUS "======================================")
message(STATUS "ğŸ“ ç¬¬ä¸‰æ–¹åº“è·¯å¾„: ${THIRD_PARTY_ROOT}")
message(STATUS "ğŸ—ï¸ æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}")
message(STATUS "ğŸ–¥ï¸ ç›®æ ‡æ¶æ„: ${CMAKE_SYSTEM_PROCESSOR}")
message(STATUS "ğŸ§  ML æ¨ç†: ${ENABLE_ML_INFERENCE}")
message(STATUS "ğŸ” æ¨¡å¼åŒ¹é…: ${HYPERSCAN_LIBRARIES}")
message(STATUS "ğŸ§ª æ„å»ºæµ‹è¯•: ${BUILD_TESTING}")
message(STATUS "")
